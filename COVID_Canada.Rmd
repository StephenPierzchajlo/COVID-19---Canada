---
title: "COVID-19 Canadian Data: Pre-processing And Simple Visualizations"
author: "Stephen Pierzchajlo"
output: github_document

---

Here I'll demonstrate how easy it is to set up a script that automatically takes COVID-19 data for the entire world, reduces it to only include regions you want, and then displays some simple figures that include up-to-date cases and deaths. The data are not ready for analysis straight away, so we need to get it in shape first.
<br/>

Here, I will take worldwide COVID-19 data and make a script that, whenever run, updates and displays COVID-19 data from Canada for cases and deaths as recent as yesterday.

```{r message=FALSE, warning=FALSE, echo = FALSE}

# This function removes the entire global environment!!!
rm(list = ls())

```

```{r message=FALSE, warning=FALSE}

# Load libraries
library(tidyr)
library(ggplot2)
library(gghighlight)
library(plyr)
library(readr)
library(plotly)
library(ggpubr)
library(dplyr)
library(ggthemes)
library(hrbrthemes)
library(devtools)
devtools::install_github('cttobin/ggthemr')
library(ggthemr)

```

Their are different COVID-19 data repositories, and I am using one that links to different worldwide *.csv* files. Each file contains data about total worldwide cases and total worldwide deaths up until 24 hours ago. Each time the code chunk below is run, it grabs an updated *.csv* file from github. This is ideal, because it means anyone can use the code in this tutorial to download a dataset and plot the same results.

```{r message=FALSE, warning=FALSE}

# Here, we load .csv files from github. These are updated daily, so everytime this analysis is run, it uses the most up to date information.

# Total Global Cases Data
COVID_Global_Wide<-read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"))

# Total Global Deaths Data
COVID_Global_Deaths_Wide <-read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"))

```

As seen below, the *.csv* file has been arranged such that each column is a date, with the value in a cell corresponding to the total cases up until that point in time. This format is not easy to work with, and it means a new column will appear every day. After 1 week this dataframe will have 7 more columns. 

```{r message=FALSE, warning=FALSE}
COVID_Global_Wide[1:10, ]
```

To make the data easier to work with, we can instead create one column called "date", and put each date from each column in it. Now instead of 100s of columns that contain dates, we only have one column.

```{r message=FALSE, warning=FALSE}

# Total global cases data in long format.
COVID_Global_Long_Date <- gather(COVID_Global_Wide, date, cases, 5:ncol(COVID_Global_Wide), factor_key=TRUE)

# Total global deaths data in long format
COVID_Global_Deaths_Long_Date <- gather(COVID_Global_Deaths_Wide, date,
                                        cases, 5:ncol(COVID_Global_Deaths_Wide), factor_key=TRUE)

# Take a look at several of the first rows.
head(COVID_Global_Long_Date)

```

Because I only want data from Canada, I need to filter out every other country. Additionally, I'll remove Canadian territories too as there are not too many people who live there. We will do this for both the cases and deaths dataframes.

```{r message=FALSE, warning=FALSE}

### SUBSETTING

# Subset Canadian provinces from total cumulative global cases data.
Covid_Canada <- subset(COVID_Global_Long_Date, `Country/Region` == "Canada")

# Subset Canadian provinces from total cumulative global deaths data.
Covid_Canada_Deaths <- subset(COVID_Global_Deaths_Long_Date, `Country/Region` == "Canada")

### FILTERING

# For province data, I'm not immediately interested in Canadian Territories, so I'll filter those out.
Covid_Canada_Filter <- Covid_Canada %>% dplyr::filter(
  `Province/State` %in% c("Ontario", "Quebec", "New Brunswick", "Manitoba", "British Columbia", "Saskatchewan", "Alberta", "Newfoundland and Labrador"))

# For province data, I'm not immediately interested in Canadian Territories, so I'll filter those out.
Covid_Canada_Deaths_Filter <- Covid_Canada_Deaths %>% dplyr::filter(
  `Province/State` %in% c("Ontario", "Quebec", "New Brunswick", "Manitoba", "British Columbia", "Saskatchewan", "Alberta", "Newfoundland and Labrador"))

```

Let's also filter dates earlier than March 1st 2020, and convert the dates column to a dates dataframe object.

```{r message=FALSE, warning=FALSE}

# Filter canadian provincial data to only include data starting from March 1st.
Covid_Canada_Filter <- Covid_Canada_Filter[352:nrow(Covid_Canada_Filter), ]
# Filter canadian provincial deaths data to only include data starting from March 1st.
Covid_Canada_Deaths_Filter <- Covid_Canada_Deaths_Filter[352:nrow(Covid_Canada_Deaths_Filter), ]

# Convert date column to date format for cases dataframe.
Covid_Canada_Filter$date <- as.Date(Covid_Canada_Filter$date, format = "%m/%d/%Y")
# Convert date column to date format for deaths dataframe.
Covid_Canada_Deaths_Filter$date <- as.Date(Covid_Canada_Deaths_Filter$date, format = "%m/%d/%Y")

```

```{r message=FALSE, warning=FALSE}

# Template for canadian provincial data cleaned for graphing.
Covid_Canada_Graph <- ddply(Covid_Canada_Filter, c("`Province/State`", "date"), summarise,
                            mean = sum(cases))

# Template for canadian provincial deaths data cleaned for graphing.
Covid_Canada_Deaths_Graph <- ddply(Covid_Canada_Deaths_Filter, c("`Province/State`", "date"),
                                   summarise, mean = sum(cases))

# Fit data to logarithmic scale.
Covid_Canada_Graph$logcases <- log(Covid_Canada_Graph$mean)

# Order dates so they appear in order on the graph.
Covid_Canada_Deaths_Graph$logcases <- log(Covid_Canada_Deaths_Graph$mean)

```

```{r message=FALSE, warning=FALSE}

# Add a column to total cases graph template indicating the data are for total cases.
Covid_Canada_Graph$Graph <- "Total Cases"

# Add a column to total deaths graph template indicating the data are for total deaths.
Covid_Canada_Deaths_Graph$Graph <- "Total Deaths"

```

```{r message=FALSE, warning=FALSE}

COVID_Canada_Final <- Covid_Canada_Graph
colnames(COVID_Canada_Final) <- c("Province/State", "Date", "Cumulative_Cases", "Cumulative_LogCases", "Graph")
COVID_Canada_Final[,c("Graph")] <- list(NULL)
COVID_Canada_Final$Cumulative_Deaths  <- Covid_Canada_Deaths_Graph$mean
COVID_Canada_Final$Cumulative_LogDeaths  <- Covid_Canada_Deaths_Graph$logcases
COVID_Canada_Final$DailyCases <- ave(COVID_Canada_Final$Cumulative_Cases,COVID_Canada_Final$`Province/State`,  FUN=function(x) c(0, diff(x)))

COVID_Canada_Final$DailyDeaths <- ave(COVID_Canada_Final$Cumulative_Deaths,COVID_Canada_Final$`Province/State`,  FUN=function(x) c(0, diff(x)))


```


```{r message=FALSE, warning=FALSE}

# For total cases, change scale to see total cases per 10,000 people.
COVID_Canada_Final$Cases_Per100000 <- ifelse(COVID_Canada_Final$`Province/State` == "Alberta",
                                      (COVID_Canada_Final$Cumulative_Cases/4345737) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "British Columbia",
                                      (COVID_Canada_Final$Cumulative_Cases/5020302) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Manitoba",
                                      (COVID_Canada_Final$Cumulative_Cases/1360396) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "New Brunswick",
                                      (COVID_Canada_Final$Cumulative_Cases/772094) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Newfoundland and Labrador",
                                      (COVID_Canada_Final$Cumulative_Cases/523790) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Ontario",
                                      (COVID_Canada_Final$Cumulative_Cases/14446515) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Quebec",
                                      (COVID_Canada_Final$Cumulative_Cases/8433301) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Saskatchewan ",
                                      (COVID_Canada_Final$Cumulative_Cases/1168423) * 100000,
                                                                              "NA"))))))))

# Change per 10,000 people column to numeric.
COVID_Canada_Final$Cases_Per100000 <- as.numeric(COVID_Canada_Final$Cases_Per100000)

```

```{r message=FALSE, warning=FALSE}

# For total deaths, change scale to see total cases per 10,000 people.
COVID_Canada_Final$Deaths_Per100000 <- ifelse(COVID_Canada_Final$`Province/State` == "Alberta",
                                      (COVID_Canada_Final$Cumulative_Deaths/4345737) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "British Columbia",
                                      (COVID_Canada_Final$Cumulative_Deaths/5020302) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Manitoba",
                                      (COVID_Canada_Final$Cumulative_Deaths/1360396) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "New Brunswick",
                                      (COVID_Canada_Final$Cumulative_Deaths/772094) * 100000,
                            ifelse(COVID_Canada_Final$`Province/State` == "Newfoundland and Labrador",
                                      (COVID_Canada_Final$Cumulative_Deaths/523790) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Ontario",
                                      (COVID_Canada_Final$Cumulative_Deaths/14446515) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Quebec",
                                      (COVID_Canada_Final$Cumulative_Deaths/8433301) * 100000,
                                ifelse(COVID_Canada_Final$`Province/State` == "Saskatchewan ",
                                      (COVID_Canada_Final$Cumulative_Deaths/1168423) * 100000,
                                                                              "NA"))))))))

# Change per 10,000 people column to numeric.
COVID_Canada_Final$Deaths_Per100000 <- as.numeric(COVID_Canada_Final$Deaths_Per100000)

```

```{r message=FALSE, warning=FALSE}
COVID_Canada_Final$month <- months(as.POSIXlt(COVID_Canada_Final$Date, format="%d/%m/%Y"))
```

```{r fig.height=5, fig.width=10, message=FALSE, warning=FALSE}
#ggthemr("light")
ggthemr("flat")
# Total cases graph.
Total_Cases <- ggplot(COVID_Canada_Final, aes(x = Date, y = Cases_Per100000, color = `Province/State`, group = `Province/State`, fill = `Province/State`)) +
  geom_area() +
  labs(x = "March 1st (2020) To Present",
       y = "Cumulative Cases Per 100,000 People",
       title = "Coronavirus Cases Per Canadian Province",
       caption = "Data source: Government of Canada") +
  scale_colour_ggthemr_d() +
  scale_x_date(date_breaks = '1 month',
        date_labels = '%B') +
  theme(axis.text.x = element_text(face = "bold", 
                           size = 9, angle = 45, hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5))
  #theme(legend.background = element_rect(fill="lightgrey",
  #                                size=0.6))# +
  #gghighlight()

Total_Cases
ggthemr_reset()

```

```{r fig.height=5, fig.width=10, message=FALSE, warning=FALSE}
#ggthemr("light")
ggthemr("flat")
# Total cases graph.
Total_Deaths <- ggplot(COVID_Canada_Final, aes(x = Date, y = Deaths_Per100000, color = `Province/State`, group = `Province/State`, fill = `Province/State`)) +
  geom_area() +
  labs(x = "March 1st (2020) To Present",
       y = "Cumulative Cases Per 100,000 People",
       title = "Coronavirus Cases Per Canadian Province",
       caption = "Data source: Government of Canada") +
  scale_colour_ggthemr_d() +
  scale_x_date(date_breaks = '1 month',
        date_labels = '%B') +
  theme(axis.text.x = element_text(face = "bold", 
                           size = 9, angle = 45, hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5))
  #theme(legend.background = element_rect(fill="lightgrey",
  #                                size=0.6))# +
  #gghighlight()

Total_Deaths
ggthemr_reset()

```

```{r message=FALSE, warning=FALSE}
Covid_Canada_Graph$diff <- ave(Covid_Canada_Graph$mean,Covid_Canada_Graph$`Province/State`,  FUN=function(x) c(0, diff(x)))
Covid_Canada_Deaths_Graph$diff <- ave(Covid_Canada_Deaths_Graph$mean,Covid_Canada_Graph$`Province/State`,  FUN=function(x) c(0, diff(x)))

```

```{r fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
#ggthemr("dust")
#ggthemr("light")
ggthemr("flat")
# Total cases graph.
Total_Cases_Hist <- ggplot(COVID_Canada_Final, aes(x = Date, y = DailyCases, color = `Province/State`, group = `Province/State`, fill = `Province/State`)) +
  #geom_area() +
  geom_bar(stat = "identity") +
  facet_wrap(~`Province/State`) +
  #theme_fivethirtyeight()+
  #theme_solarized() +
  #theme_tufte() +
  #theme_economist() + scale_fill_economist()+
  ylab("New Daily Cases") +
  xlab("March 1st To Present") +
  ggtitle("Daily Coronavirus Cases Per Canadian Province")+
  scale_colour_ggthemr_d() +
  scale_x_date(name = 'April 2020 to present', date_breaks = '1 month',
        date_labels = '%B') +
  theme(axis.text.x = element_text(face = "bold", 
                           size = 8, angle = 45, hjust = 1)) +
  #scale_colour_brewer(type = "seq", palette = "Spectral") +
  gghighlight()

Total_Cases_Hist

```


```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
#ggthemr("dust")
#ggthemr("light")
ggthemr("flat")
# Total cases graph.
Total_Cases_Hist <- ggplot(COVID_Canada_Final, aes(x = Date, y = DailyDeaths, color = `Province/State`, group = `Province/State`, fill = `Province/State`)) +
  #geom_area()+
  geom_bar(stat = "identity") +
  facet_wrap(~`Province/State`) +
  #theme_fivethirtyeight()+
  #theme_solarized() +
  #theme_tufte() +
  #theme_economist() + scale_fill_economist()+
  ylab("New Daily Cases") +
  xlab("March 1st To Present") +
  ggtitle("Daily Coronavirus Cases Per Canadian Province")+
  scale_colour_ggthemr_d() +
  scale_x_date(name = 'April 2020 to present', date_breaks = '1 month',
        date_labels = '%B') +
  theme(axis.text.x = element_text(face = "bold", 
                           size = 8, angle = 45, hjust = 1)) +
  #scale_colour_brewer(type = "seq", palette = "Spectral") +
  gghighlight()

Total_Cases_Hist

```
